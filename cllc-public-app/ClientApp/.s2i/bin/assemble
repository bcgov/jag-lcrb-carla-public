#!/bin/bash

# S2I Assemble Script
#
# This script is based on the S2I assemble script for dotnet 2, with the following extra features:
#
# 1. A Sonarqube scan can be done on the source
# 2. A Snyk scan can be done on the source
# 3. Dotnet tests can be done
# 4. Or a regular build for production of an application image can be done.

set -e
# Include filenames beginning with a '.' when installing the application source code.
shopt -s dotglob

if [ -n "${DOTNET_VERBOSITY}" ]; then
  echo "[assemble] ---> Environment:"
  env | sort
  VERBOSITY_OPTION="-v ${DOTNET_VERBOSITY}"
else
  VERBOSITY_OPTION=""
fi

echo "[assemble] ---> Installing application source..."
if [ -d /tmp/src ]; then
  mv /tmp/src/* ./
fi

if [ -n "$NPM_MIRROR" ]; then
  echo "[assemble] Setting npm mirror to $NPM_MIRROR"
  npm config set registry "$NPM_MIRROR" || echo "[assemble] WARNING: npm mirror failed, continuing"
fi

# edit version info files.
sed -i 's^<!-- UI_GIT_REF -->^'"$OPENSHIFT_BUILD_REFERENCE"'^g' src/app/components/version-info/version-info-dialog.component.html
sed -i 's^<!-- UI_GIT_COMMIT -->^'"$OPENSHIFT_BUILD_COMMIT"'^g' src/app/components/version-info/version-info-dialog.component.html
sed -i 's^<!-- UI_GIT_REPO -->^'"$OPENSHIFT_BUILD_SOURCE"'^g' src/app/components/version-info/version-info-dialog.component.html
sed -i 's^<!-- UI_BUILD_DATE -->^'"$(date)"'^g' src/app/components/version-info/version-info-dialog.component.html

echo "[assemble] PHASE1=${PHASE1:-<empty>} PHASE2=${PHASE2:-<empty>}"

if [ -n "${PHASE1}" ]; then
  echo "[assemble] PHASE1: installing Node dependencies..."

  if [ -f package-lock.json ]; then
    echo "[assemble] PHASE1: running npm ci."
    npm ci
  else
    echo "[assemble] PHASE1: running npm install."
    npm install
  fi

  echo "[assemble] PHASE1: completed."
fi

if [ -n "${PHASE2}" ]; then
  echo "[assemble] PHASE2: building Angular app..."

  mkdir /opt/app-root/dist

  # Get the base href value from the environment variable or use a default
  BASE_HREF_VALUE="${BASE_HREF:-/lcrb}"  # Fallback to '/lcrb' if not set
  CLEAN_BASE_HREF_VALUE="${BASE_HREF_VALUE#/}"  # Remove leading slash for directory name

  echo "[assemble] PHASE2: Creating output directory /opt/app-root/dist/$CLEAN_BASE_HREF_VALUE"
  # Create output directory
  mkdir -p "/opt/app-root/dist/$CLEAN_BASE_HREF_VALUE"

  echo "[assemble] PHASE2: Building Angular app with base href: $BASE_HREF_VALUE"
  # Run Angular build
  npm run build -- --configuration production --base-href "$BASE_HREF_VALUE/" --outputPath="/opt/app-root/src/dist/$CLEAN_BASE_HREF_VALUE"

  # fix permissions
  fix-permissions /opt/app-root/src/dist

  echo "[assemble] PHASE2: completed."
fi
